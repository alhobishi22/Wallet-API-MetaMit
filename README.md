# محلل رسائل المحافظ (Wallet SMS Analyzer)

تطبيق لتحليل رسائل المحافظ الإلكترونية وعرض كشف حساب للعمليات المالية.

<div align="center">
  <img src="static/images/logo.svg" alt="MetaBit Safety Logo" width="200">
  <h3>MetaBit Safety</h3>
  <p>تحليل دقيق ومراقبة آمنة لمعاملاتك المالية</p>
</div>

## جدول المحتويات

- [نظرة عامة](#نظرة-عامة)
- [الميزات](#الميزات)
- [المتطلبات](#المتطلبات)
- [هيكل المشروع](#هيكل-المشروع)
- [إعداد قاعدة البيانات](#إعداد-قاعدة-البيانات)
- [التثبيت](#التثبيت)
- [كيفية الاستخدام](#كيفية-الاستخدام)
- [أنماط الرسائل المدعومة](#أنماط-الرسائل-المدعومة)
- [منطق تأكيد المعاملات](#منطق-تأكيد-المعاملات)
- [تصميم واجهة المستخدم](#تصميم-واجهة-المستخدم)
- [تطوير المشروع](#تطوير-المشروع)
- [الأمان والخصوصية](#الأمان-والخصوصية)
- [المساهمة](#المساهمة)
- [الترخيص](#الترخيص)

## نظرة عامة

محلل رسائل المحافظ هو تطبيق ويب مبني على إطار Flask ويهدف إلى تحليل رسائل SMS الواردة من خدمات المحافظ الإلكترونية المختلفة. يقوم التطبيق باستخراج البيانات المهمة مثل المبالغ والأرصدة وأنواع المعاملات، ثم يعرضها بطريقة منظمة ومرئية للمستخدم.

## الميزات

- **تحليل رسائل متعددة**: دعم لرسائل SMS من محافظ متعددة (جيب، جوالي، كاش)
- **استخراج تلقائي**: استخراج تفاصيل المعاملات بشكل تلقائي من نصوص الرسائل
- **عرض مفصل**: ملخص للمعاملات حسب العملة مع تفاصيل كاملة
- **تمثيل بصري**: رسوم بيانية توضيحية لتوزيع المعاملات والاتجاهات
- **واجهة متعددة اللغات**: دعم كامل للواجهات باللغة العربية مع تصميم RTL (من اليمين إلى اليسار)
- **دعم عملات متعددة**: دعم للعملات المختلفة (ريال يمني، ريال سعودي، دولار أمريكي)
- **تصدير البيانات**: إمكانية تصدير البيانات بصيغة JSON
- **التحقق من المعاملات**: آلية تلقائية للتحقق من صحة المعاملات ومطابقتها مع الأرصدة المتوقعة
- **تخزين في قاعدة البيانات**: حفظ جميع البيانات في قاعدة بيانات PostgreSQL مع إمكانية الاسترجاع والتحليل

## المتطلبات

- Python 3.8 أو أحدث
- PostgreSQL 16
- Flask 2.0 أو أحدث
- SQLAlchemy
- Flask-Migrate
- Pandas (للتحليل الإحصائي)
- Matplotlib (للرسوم البيانية)
- وحدات Python الأخرى المذكورة في ملف requirements.txt

## هيكل المشروع

```
wallet-sms-analyzer/
├── app.py                  # الملف الرئيسي للتطبيق
├── models.py               # تعريف نماذج قاعدة البيانات
├── wsgi.py                 # نقطة دخول تطبيق WSGI للنشر
├── requirements.txt        # مكتبات Python المطلوبة
├── static/                 # ملفات ثابتة (CSS، JS، الصور)
│   ├── css/
│   ├── js/
│   └── images/
├── templates/              # قوالب HTML
│   ├── base.html           # القالب الأساسي
│   ├── index.html          # صفحة البداية
│   └── wallet.html         # صفحة تفاصيل المحفظة
├── migrations/             # ملفات ترحيل قاعدة البيانات
└── instance/               # بيانات التطبيق المحلية (قاعدة البيانات SQLite)
```

## إعداد قاعدة البيانات

يستخدم المشروع PostgreSQL 16 كقاعدة بيانات. يمكنك إعداد قاعدة البيانات كالتالي:

1. قم بتثبيت PostgreSQL 16 من [الموقع الرسمي](https://www.postgresql.org/download/)
2. قم بإنشاء قاعدة بيانات جديدة:
   ```sql
   CREATE DATABASE wallet_sms_analyzer;
   CREATE USER wallet_user WITH PASSWORD 'your_password';
   GRANT ALL PRIVILEGES ON DATABASE wallet_sms_analyzer TO wallet_user;
   ```
3. قم بتعديل معلومات الاتصال بقاعدة البيانات في ملف التكوين (config.py أو في المتغيرات البيئية):
   ```python
   SQLALCHEMY_DATABASE_URI = 'postgresql://wallet_user:your_password@localhost/wallet_sms_analyzer'
   ```

إذا كنت ترغب في إضافة العمود الجديد `is_confirmed_db` إلى قاعدة بيانات موجودة، يمكنك تشغيل سكريبت `add_column.py`:
```bash
python add_column.py
```

## التثبيت

1. قم بتثبيت Python من [الموقع الرسمي](https://www.python.org/downloads/)
2. قم بتنزيل أو استنساخ هذا المشروع:
   ```bash
   git clone https://github.com/alhobishi22/Wallet-API-MetaMit.git
   cd Wallet-API-MetaMit
   ```
3. افتح موجه الأوامر (Command Prompt) وانتقل إلى مجلد المشروع
4. قم بإنشاء بيئة افتراضية (اختياري ولكن موصى به):
   ```bash
   python -m venv venv
   # في Windows
   venv\Scripts\activate
   # في Linux/Mac
   source venv/bin/activate
   ```
5. قم بتثبيت المتطلبات:
   ```bash
   pip install -r requirements.txt
   ```
6. قم بإعداد قاعدة البيانات كما هو موضح في القسم السابق
7. قم بتهيئة قاعدة البيانات:
   ```bash
   # داخل بيئة Python
   from app import db
   db.create_all()
   ```
8. قم بتشغيل التطبيق:
   ```bash
   python app.py
   ```
9. افتح المتصفح وانتقل إلى `http://localhost:5000`

## كيفية الاستخدام

### رفع الرسائل

1. **جمع الرسائل**: قم بنسخ رسائل المحافظ من تطبيق Forward SMS أو أي تطبيق آخر لتخزين الرسائل.
2. **الوصول إلى التطبيق**: افتح المتصفح وانتقل إلى `http://localhost:5000`.
3. **رفع الرسائل**: انقر على زر "رفع رسائل" والصق نص الرسائل في النموذج المخصص.
4. **معالجة البيانات**: انقر على زر "تحليل" لمعالجة الرسائل واستخراج المعاملات.

### عرض المعاملات

1. **الصفحة الرئيسية**: تعرض ملخصًا لجميع المحافظ مع إجمالي المعاملات لكل محفظة.
2. **تفاصيل المحفظة**: انقر على "عرض التفاصيل" لمحفظة معينة لمشاهدة جميع المعاملات الخاصة بها.
3. **تصفية البيانات**: يمكنك استخدام أدوات التصفية لعرض معاملات محددة (حسب العملة، التاريخ، النوع).
4. **الرسوم البيانية**: استعرض الرسوم البيانية لتحليل اتجاهات المعاملات والنفقات.

## أنماط الرسائل المدعومة

يدعم التطبيق تحليل أنماط مختلفة من رسائل المحافظ:

### محفظة جيب (Jaib)
```
اضيف مبلغ 24000 للحساب الخاص بك في محفظة جيب من شخص آخر.
الرصيد المتبقي 45000 ريال يمني. 
```

### محفظة جوالي (Jawali)
```
استلمت مبلغ 100.00 ريال سعودي من ‪+966512345678‬‏
الرصيد الحالي: 450.00 ريال سعودي
```

### محفظة كاش (Cash)
```
تم إضافة 30,000 ريال يمني إلى حسابك.
رصيدك الجديد هو 125,000 ريال يمني.
```

يمكن إضافة دعم لأنماط رسائل جديدة عن طريق تعديل التعبيرات النمطية (regex) في ملف `app.py`.

## منطق تأكيد المعاملات

يستخدم التطبيق منطقًا خاصًا للتحقق من صحة المعاملات:

1. **المعاملة الأولى**: تُعتبر المعاملة الأولى لكل عملة "غير مؤكدة" بشكل افتراضي، لأنه لا يمكن التحقق منها.
2. **المعاملات اللاحقة**: يتم التحقق من المعاملات اللاحقة بمقارنة الرصيد المذكور في الرسالة مع الرصيد المتوقع (المحسوب من المعاملة السابقة):
   - الرصيد المتوقع = الرصيد السابق + المبلغ (للإضافة) أو الرصيد السابق - المبلغ (للخصم)
   - يتم استخدام هامش تفاوت صغير (0.01) للتعامل مع أخطاء التقريب
3. **تخزين حالة التأكيد**: يتم تخزين حالة التأكيد في عمود `is_confirmed_db` في قاعدة البيانات، ويتم تحديثها عند عرض المعاملات

## تصميم واجهة المستخدم

تم تصميم واجهة المستخدم بألوان وتخطيط يتوافق مع هوية MetaBit Safety:

- **التدرج اللوني الأساسي**: #0d6efd → #6610f2
- **التدرج اللوني الثانوي**: #6610f2 → #fd7e14
- **الشعار**: شعار SVG مخصص بألوان متدرجة
- **التصميم**: تصميم متجاوب يعمل على مختلف أحجام الشاشات
- **اتجاه النص**: دعم كامل للغة العربية واتجاه RTL

## تطوير المشروع

### إضافة دعم لمحفظة جديدة

1. أضف نمط المحفظة الجديدة إلى قائمة `WALLET_TYPES` في ملف `app.py`
2. قم بإنشاء تعبير نمطي لتحليل رسائل هذه المحفظة في وظيفة `process_sms`
3. قم بتحديث واجهة المستخدم لعرض المحفظة الجديدة

### تعديل منطق تأكيد المعاملات

منطق تأكيد المعاملات موجود في وظيفة `wallet` في ملف `app.py`. يمكنك تعديله لتغيير:
- هامش التفاوت المسموح به
- كيفية التعامل مع المعاملة الأولى
- شروط إضافية للتأكيد

### تعديل نموذج البيانات

إذا كنت ترغب في إضافة حقول جديدة إلى نموذج `Transaction`:
1. قم بتحديث الفئة `Transaction` في ملف `models.py`
2. قم بإنشاء وتطبيق ترحيل قاعدة البيانات لإضافة الأعمدة الجديدة

## الأمان والخصوصية

- جميع البيانات تُخزن في قاعدة البيانات المحلية
- لا يتم إرسال أي بيانات إلى خوادم خارجية
- يستخدم التطبيق رأس `Cache-Control` لمنع تخزين البيانات المؤقت في المتصفح
- يمكنك مسح جميع البيانات في أي وقت باستخدام زر "مسح البيانات"

## المساهمة

نرحب بمساهماتكم لتحسين هذا التطبيق. يمكنكم:
- الإبلاغ عن الأخطاء عبر نظام Issues
- اقتراح ميزات جديدة
- تحسين الكود الحالي عبر Pull Requests
- تحسين التوثيق والترجمة

## الترخيص

هذا المشروع مرخص تحت رخصة MIT.
